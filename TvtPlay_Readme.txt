TVTest TvtPlay Plugin ver.0.5 + BonDriver_Pipe.dll

■概要
TVTest付属のBonDriver_UDPまたは専用のBonDriver_Pipeを使ってローカルTSファイルを
再生するプラグインです。

■動作環境
・Windows XP以降(ただしVistaは未確認)
・TVTest ver.0.7.16 32bit以降、or対応するTVH264
・Visual C++ 2005 SP1 再頒布可能パッケージ(TVTestが起動するなら入ってるはず)

■以前のバージョン(ver.0.4)からの移行
TvtPlay.tvtpを置きかえてください(ビルドの都合でファイルサイズが小さくなっていま
す)。設定ファイルはそのまま引き継げます。

■以前のバージョン(人柱版)からの移行
そのままTvtPlay.tvtpとBonDriver_Pipe.dllを置きかえてください。仕様変更によりシー
ク系のキー割り当てが解除されるので注意してください。

■使い方
TVTestのPluginsフォルダにTvtPlay.tvtpを入れてください。BonDriver_Pipe.dllは使用
しないならば捨ててください(後述の「BonDriver_Pipe.dllについて」を参照)。
TVTest起動オプションに/tvtplayを含むか、最後のオプションに拡張子.ts .m2t .m2ts
いずれかのファイルパスを付加するとプラグインは有効になり、起動時にそのファイルを
開きます。/tvtplayを含む場合はファイルパスの有無、拡張子は任意です。
例:
  TVTest.exe /d BonDriver_UDP.dll /tvtplay [foo.ts]
  TVTest.exe /d BonDriver_UDP.dll foo.ts
  (TVTestのデフォルトのBonDriverに"BonDriver_UDP.dll"を指定している場合、
  /d BonDriver_UDP.dllは不要)

起動するとTVTestウインドウ下部にコントロールが表示されます(デザイン的に細いウイ
ンドウ枠(右クリック→バー枠→細いウインドウ枠を使用)推奨)。コントロール左側の9個
のボタンは左から、ファイルを開く、シーク-60秒/-15秒/-5秒、一時停止、シーク5秒/15
秒/60秒、ファイル末尾へシーク、です。コントロール中央はシークバーになっていて、
左クリックで任意の位置にシーク、右クリックで再生を一時停止/再開します。コントロ
ール右側には再生位置および総再生時間が表示されます。

■BonDriver_Pipe.dllについて
導入には Visual C++ 2005 SP1 再頒布可能パッケージが必要です。BonDriver_UDPのプロ
セス間通信方式をパイプに改変したものです。転送中にドロップしないのと、UDP/IPのス
タックを介さないので軽い(はず…)のが利点です。興味のある方は使ってみてください。
TVTestに対してはBonDriver_UDPのフリをするので、BonDriver_UDPと同じ要領で使ってく
ださい。BonDriver_UDPと同時使用もできます。

■設定ファイルについて
設定ファイル"TvtPlay.ini"は初回使用時プラグインフォルダに自動作成されます。必要
な場合はこれを直接編集してカスタマイズしてください。以下は設定キーの説明です。

TsAutoClose / TsAutoLoop
    末尾まで再生後にファイルを閉じる/先頭に戻る[=1]かどうか
    # 追っかけ再生中は発動しません。
TsResetAllOnSeek
    シーク時にビューアリセットではなく全体リセットをかける[=1]かどうか
    # シーク後に音無しor映像無しになる可能性を軽減できるかもしれない。
TsResetDropInterval【ver.0.5～】
    シーク後にドロップカウントをリセットするために監視する間隔(ミリ秒)、またはリ
    セットしない[=0]
    # シーク後、ドロップカウントの増加が止まれば値をリセットします。
    # 後述の「ドロップカウントについて」も参照
ToBottom
    フルスクリーン時、コントロールの位置を画面のもっとも下に置く[=1]かどうか
DispTot【ver.0.5～】
    シークバーに放送時刻を表示する[=1]かどうか
DispTotOnStatus【ver.0.5～】
    再生位置の表示の隣に放送時刻を表示する[=1]かどうか
StatusItemWidth【ver.0.5～】
    再生位置・総再生時間の表示部分のピクセル幅
TimeoutOnCommand / TimeoutOnMouseMove
    フルスクリーン時、キーコマンド/マウス操作をおこなった後にコントロールを表示
    する時間をミリ秒で指定、または表示しない[=0]
IconImage
    アイコン画像を絶対パスかTVTestフォルダからの相対パスで指定
    # プラグインに内蔵されている"src/Buttons.bmp"の画像を置き換えます。高さ16px
    # のモノクロBMPファイルを指定してください。
Seek[A-H]
    シーク時間をミリ秒で指定する
    # ボタンコマンドやキー割り当ての"シーク:A"～"シーク:H"に対応します。
Button[00-13]
    ボタンのアイコン番号とボタンコマンドを指定する
    # フォーマットは"{アイコン番号},{ボタンコマンド(Open,Closeなど)}"
    # ';'でコメントアウトするか何も指定しなければそのボタンは消えます。
    # 並べ替えもできます。
    # アイコン画像の X座標=(アイコン番号)×16 の位置をアイコンとして使用します。
    # PauseとLoopコマンドは右隣のアイコンも使います。

■ドロップカウントについて
シークを行うとTVTestステータスバーのドロップカウントは増加します。これはTSパケッ
トの巡回カウンタ(continuity counter)が不連続になるためで、正常な動作です。
また、この巡回カウンタは重畳するパケットのPIDごとにカウントアップしていくので、
送出頻度の低いパケット(EITやTOTなど)はドロップ判定が遅れます。シーク数秒～十数秒
後にドロップカウントがいくらか増えることがあるのは、おそらくこれが原因です。この
挙動が気持ちわるいひとはTsResetAllOnSeekを1にするかTsResetDropIntervalを大きめの
値(2000～4000程度)にしてみてください。

■仕様
・シーク後に音無しor映像無しになることがあります(解決策に一長一短あって今のとこ
  ろこの仕様です)。当方ではシーク200回のうち7回発生しました。発生したときはビュ
  ーアリセットしたりもう一度シークしたりしてください。
・総再生時間の表示は数秒以内の誤差がでる場合があります。また、総再生時間はファイ
  ル先頭および末尾の情報から算出した値なので、カット編集されている場合は不正確に
  なります
・26.5時間以上のTSファイルはおそらく正しく再生できません(Program Clock Reference
  が巡回する関係上)
・再生位置から一度に13.2時間以上離れた位置にシークすると、誤った位置に飛びます
・追っかけ再生に対応しています
・追っかけ再生中の総再生時間は推計です
・勢いでつくったので不具合もけっこうあるかも

■ソースについて
当プラグインの作成に当たり、EpgDataCap_BonのEpgTimerPlugInを参考にしました。また
、TSファイルの同期・解析のために、tsselect-0.1.8(
http://www.marumo.ne.jp/junk/tsselect-0.1.8.lzh)よりソースコードを改変利用してい
ます。また、TVTest(ver.0.7.20)からソースコードを流用しています。特に以下のファイ
ルはほぼ改変なしに流用しています(差分は"diff_TVTestStatusView_orig.txt"を参照)
  "Aero.cpp"
  "Aero.h"
  "BasicWindow.cpp"
  "BasicWindow.h"
  "ColorScheme.cpp"
  "ColorScheme.h"
  "DrawUtil.h"
  "DrawUtil.cpp"
  "Settings.cpp"
  "Settings.h"
  "StatusView.cpp"
  "StatusView.h"
  "Theme.cpp"
  "Theme.h"
ソースコメントに流用元を記述しています。流用部分については流用元の規約に注意し、
その他の部分は勝手に改変・利用してもらって構いません。

■更新履歴
ver.0.5 (2011-08-27)
・対応するTVTestをver.0.7.16に引き上げた(実際にはTvtPlay0.3からこうだった)
・ファイルを開きなおしたときに再生ボタンを再描画していなかったのを修正
・通常表示のときコントロール下部のマージンが1px少なくなってたのを修正
・シーク後にドロップカウントをリセットするようにした
・BonDriver_Fileのソースを参考にPCRの取得部分をより合理的にした
  ・ソースの保管場所書きこんでくれた方サンクスです
・Time Offset Tableをもとに放送時刻を表示可能にした(個人的な需要)
・TVTestに合わせて最終ビルドをVisualC++2005(EE)にして/MT→/MDに変更
ver.0.4 (2011-08-23)
・人柱版表記をはずした(人柱さん達に感謝!)
・ボタンとシーク量、ほか細かい部分をカスタマイズ可能にした
・一時停止後も少しだけ再生が進んでしまうのを改善
・BonDriver_Pipeのパイプのバッファ量を効率的な値に修正
ver.0.3 (2011-08-20)
・スレッドの要望をもとに3点を追加した
  ・複数起動禁止時に複数起動されたとき、ファイルを開きなおすようにした
  ・追っかけ再生時、総再生時間の右端に'+'を付けた
  ・1時間未満の時刻表示を簡略化
・ストリームのアンダーランを抑制する微調整
・一時停止からの復帰時にカクつく場合があったのを修正
・BonDriver_Pipeつくってみた
・マルチディスプレイに対応できてなかったようなので修正(できたかな…)
ver.0.2 (2011-08-16)
・下記の修正では修正できてなかったため、さらに差し替えました
  ・修正分は"diff_02r1_02r2.txt"を参照
ver.0.2 (2011-08-15)
・バグ発見のため15日21時頃に差し替えました
  ・ファイルパス付で起動すると起動時にフリーズする不具合を修正(TVTestの起動完了
    を待たずにRESET_VIEWERを発行したため、TVTest内部でデッドロックした模様)
・スレッドで要望のあったもののうち、とりあえず容易な2点を追加した
  ・プラグインが有効なときはファイルをドラッグ&ドロップできるようにした
  ・キー割り当てを追加した
・コントロールの描画をすこし修正
・マルチディスプレイに対応したかもしれない(環境が無いので…)
ver.0.1 (2011-08-13)
・初版
